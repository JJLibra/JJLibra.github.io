<h1 id="实验一：多级反馈队列调度算法"><a href="#实验一：多级反馈队列调度算法" class="headerlink" title="实验一：多级反馈队列调度算法"></a>实验一：多级反馈队列调度算法</h1><h2 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h2><p>通过模拟多级反馈队列进程调度算法，加深对进程调度算法、分时系统、时间片、进程优先级、进程状态、进程控制的理解。</p>
<h2 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h2><p>用C语言或Python编写一个程序，模拟多级反馈队列调度算法的执行过程，要求：</p>
<ol>
<li><p>队列4级，每一级的队列长度都为 10，第一级的时间片为 T，第二级的时间片为 2T，第三级的时间片为4T，第四级的时间片为 8T；（T的大小自己定）</p>
</li>
<li><p>立即抢占的调度算法；</p>
</li>
<li><p>要有：在调度n级（n&gt;1）队列时，有新来的进程进入系统。</p>
</li>
</ol>
<h2 id="程序流程图"><a href="#程序流程图" class="headerlink" title="程序流程图"></a>程序流程图</h2><p><img src="https://s11.ax1x.com/2023/12/18/piI8UP0.png" alt="流程图"></p>
<h2 id="程序代码"><a href="#程序代码" class="headerlink" title="程序代码"></a>程序代码</h2><p>本次使用了C语言进行程序编写，开发环境：Ubuntu 20.04，主要代码如下：</p>
<h3 id="结构体与变量"><a href="#结构体与变量" class="headerlink" title="结构体与变量"></a>结构体与变量</h3><h4 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">int</span> ArrivalTime; <span class="comment">// 到达时间</span></span><br><span class="line">	<span class="type">int</span> WorkTime;	 <span class="comment">// 服务时间</span></span><br><span class="line">	<span class="type">int</span> number;		 <span class="comment">// 到达顺序</span></span><br><span class="line">	<span class="type">int</span> flag;		 <span class="comment">// 0等待，1运行完成</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Node</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; Process;</span><br></pre></td></tr></table></figure>

<h4 id="多级队列"><a href="#多级队列" class="headerlink" title="多级队列"></a>多级队列</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">QueueList</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">int</span> TimeSlice;			<span class="comment">// 时间片</span></span><br><span class="line">	<span class="type">int</span> length;				<span class="comment">// 队列长度</span></span><br><span class="line">	Process *front;			<span class="comment">// 队列第一个进程指针</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">QueueList</span> *<span class="title">next</span>;</span> <span class="comment">// 下一个队列</span></span><br><span class="line">&#125; Queue;</span><br></pre></td></tr></table></figure>

<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Queue *head = <span class="literal">NULL</span>; 	<span class="comment">// 多级队列头节点</span></span><br><span class="line">Queue *QLists[<span class="number">50</span>]; 		<span class="comment">// 多级队列</span></span><br><span class="line">Process *Finish = <span class="literal">NULL</span>; <span class="comment">// 已完成</span></span><br><span class="line"><span class="type">int</span> time = <span class="number">0</span>; 			<span class="comment">// 运行时间</span></span><br><span class="line"><span class="type">int</span> Maxsize = <span class="number">4</span>; 		<span class="comment">// 队列级数</span></span><br></pre></td></tr></table></figure>

<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h4 id="初始化队列"><a href="#初始化队列" class="headerlink" title="初始化队列"></a>初始化队列</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">InitQueue</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	yellow_printf(<span class="string">&quot;Welcome!\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Number of queue progressions:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;Maxsize);</span><br><span class="line">	Queue *temp;</span><br><span class="line">	<span class="type">int</span> count = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; Maxsize; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		temp = (Queue *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Queue));</span><br><span class="line">		temp-&gt;front = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">if</span>(i==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			temp-&gt;TimeSlice=T;</span><br><span class="line">			count *= <span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			temp-&gt;TimeSlice = T*count; <span class="comment">// 设置各级队列时间片，当前时间片T，2T，4T，8T...</span></span><br><span class="line">			count*=<span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		temp-&gt;length = <span class="number">10</span>;				 <span class="comment">// 限制队列过长，以免出现饥饿问题</span></span><br><span class="line">		temp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">if</span> (head == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			head = temp;</span><br><span class="line">			temp = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			Queue *temp2;</span><br><span class="line">			temp2 = head;</span><br><span class="line">			<span class="keyword">while</span> (temp2-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				temp2 = temp2-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">			temp2-&gt;next = temp;</span><br><span class="line">			temp = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="初始化进程"><a href="#初始化进程" class="headerlink" title="初始化进程"></a>初始化进程</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">InitProcess</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> num;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Number of processes:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;num);</span><br><span class="line">	<span class="keyword">while</span> (num &gt; <span class="number">10</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		red_printf(<span class="string">&quot;Exceed the queue length!\n&quot;</span>);</span><br><span class="line">		yellow_printf(<span class="string">&quot;Please re-energize ...\n&quot;</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;num);</span><br><span class="line">	&#125;</span><br><span class="line">	Process *temp;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		temp = (Process *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Process));</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Arrival and run time of the %d process:\n&quot;</span>, i + <span class="number">1</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;temp-&gt;ArrivalTime, &amp;temp-&gt;WorkTime);</span><br><span class="line">		temp-&gt;flag = <span class="number">0</span>;</span><br><span class="line">		temp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		temp-&gt;number = i + <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span> (head-&gt;front == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			temp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">			head-&gt;front = temp;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			Process *temp2;</span><br><span class="line">			temp2 = head-&gt;front;</span><br><span class="line">			<span class="keyword">while</span> (temp2-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				temp2 = temp2-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">			temp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">			temp2-&gt;next = temp;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">SortProcess</span><span class="params">()</span>; <span class="comment">// 按到达时间排序</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">RunFirstProcess</span><span class="params">(Queue *Q)</span>； <span class="comment">// 运行 Q 队列的首进程</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Insert2NextQueue</span><span class="params">(Process *P, Queue *Q)</span>； <span class="comment">// 将进程 P 插入 Q 队尾</span></span><br></pre></td></tr></table></figure>

<h4 id="调度算法"><a href="#调度算法" class="headerlink" title="调度算法"></a>调度算法</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">MLFQ</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	QLists[<span class="number">1</span>] = head;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt;= Maxsize; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		QLists[i] = QLists[i - <span class="number">1</span>]-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 保证结束的时刻</span></span><br><span class="line">	<span class="keyword">if</span> (QLists[<span class="number">1</span>]-&gt;front != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		time = QLists[<span class="number">1</span>]-&gt;front-&gt;ArrivalTime;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 定义一个标志变量，表示是否有进程运行，0表示没有进程运行</span></span><br><span class="line">		<span class="type">int</span> flag = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= Maxsize; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// 检查每个队列的第一个进程是否满足运行条件</span></span><br><span class="line">			<span class="keyword">if</span> (QLists[i]-&gt;front != <span class="literal">NULL</span> &amp;&amp; time &gt;= QLists[i]-&gt;front-&gt;ArrivalTime)</span><br><span class="line">			&#123;</span><br><span class="line">				RunFirstProcess(QLists[i]);</span><br><span class="line">				<span class="comment">// 将标志变量设为1，表示有进程运行</span></span><br><span class="line">				flag = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 如果标志变量为0，表示没有进程运行</span></span><br><span class="line">		<span class="keyword">if</span> (flag == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">int</span> j=<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">for</span>(j=<span class="number">1</span>;j &lt;= Maxsize;j++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(QLists[j]-&gt;front != <span class="literal">NULL</span>) <span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 判断是否所有进程都运行完毕</span></span><br><span class="line">			<span class="keyword">if</span> (j==Maxsize+<span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				green_printf(<span class="string">&quot;\nAll processes have finished running&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// 如果不是，就增加时间并继续循环</span></span><br><span class="line">				time++;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><h4 id="代码创新点"><a href="#代码创新点" class="headerlink" title="代码创新点"></a>代码创新点</h4><ol>
<li>该程序可自定义队列级数，本实验为四级队列</li>
<li>程序输出字体颜色根据提示信息有所不同</li>
</ol>
<p><img src="https://s11.ax1x.com/2023/12/18/piI8d2T.png" alt="运行结果"></p>
<h2 id="规范性输入"><a href="#规范性输入" class="headerlink" title="规范性输入"></a>规范性输入</h2><p>本实验要求每一级队列长度为 10</p>
<p><img src="https://s11.ax1x.com/2023/12/18/piI8aGV.png" alt="规范性"></p>
<h2 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h2><h4 id="问题-1"><a href="#问题-1" class="headerlink" title="问题 1"></a>问题 1</h4><p>首次编写程序时，未考虑进程到达时间的先后，即进程 1 的到达时间大于进程 2 的情况，导致运行结果出错</p>
<h4 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案 1"></a>解决方案 1</h4><p>在进入调度函数之前，依据进程到达时间进行一次快排</p>
<h4 id="问题-2"><a href="#问题-2" class="headerlink" title="问题 2"></a>问题 2</h4><p>当进程 1 运行结束，但进程 2 还未到达时，在主循环中没有更新运行时刻，导致运行结果出错</p>
<h4 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案 2"></a>解决方案 2</h4><p>主循环添加时刻 Time 的自增</p>
<h2 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h2><p>上文中的测试用例为</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">进程号    		到达时间		运行时间</span><br><span class="line">  1				 1			   22</span><br><span class="line">  2				44			   3</span><br><span class="line">  3				32             44</span><br><span class="line">  4				11			   5</span><br><span class="line">  5				23			   13</span><br></pre></td></tr></table></figure>

<p>四级队列时间片分别为 1，2，4，8</p>
<ol>
<li>进程 1 最先到达，运行 1 个时间片后，没有进程到达，进入二级队列继续运行……</li>
<li>直到进程 4 在 T &#x3D; 11时到达，进程 1 被抢占（此时进程 1 位于四级队列）</li>
<li>直到进程 2 运行完毕且上级队列无进程需要运行时，运行进程 1</li>
<li>……</li>
</ol>
<p>最终运行结果如上图，计算可得结果正确</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义进程结构</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">int</span> ArrivalTime; <span class="comment">// 到达时间</span></span><br><span class="line">	<span class="type">int</span> WorkTime;	 <span class="comment">// 服务时间</span></span><br><span class="line">	<span class="type">int</span> number;		 <span class="comment">// 到达顺序</span></span><br><span class="line">	<span class="type">int</span> flag;		 <span class="comment">// 0等待，1运行完成</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Node</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; Process;</span><br><span class="line"><span class="comment">// 定义队列</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">QueueList</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">int</span> TimeSlice;			<span class="comment">// 时间片</span></span><br><span class="line">	<span class="type">int</span> length;				<span class="comment">// 队列长度</span></span><br><span class="line">	Process *front;			<span class="comment">// 队列第一个进程指针</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">QueueList</span> *<span class="title">next</span>;</span> <span class="comment">// 下一个队列</span></span><br><span class="line">&#125; Queue;</span><br><span class="line"></span><br><span class="line">Queue *head = <span class="literal">NULL</span>;</span><br><span class="line">Queue *QLists[<span class="number">50</span>];</span><br><span class="line">Process *Finish = <span class="literal">NULL</span>; <span class="comment">// 已完成</span></span><br><span class="line"><span class="type">int</span> time = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> Maxsize = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出颜色字体</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">color_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* color_code, <span class="type">const</span> <span class="type">char</span>* format, ...)</span> &#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, color_code); <span class="comment">// 设置颜色</span></span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args); <span class="comment">// 打印格式化的文本</span></span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>); <span class="comment">// 重置到默认颜色</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">red_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> &#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">blue_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">green_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> </span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">darkgreen_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> </span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[36m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">yellow_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> </span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[33m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">purple_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> </span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[35m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 初始化队列</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">InitQueue</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	yellow_printf(<span class="string">&quot;Welcome!\n&quot;</span>);</span><br><span class="line">	yellow_printf(<span class="string">&quot;Number of queue progressions:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;Maxsize);</span><br><span class="line">	Queue *temp;</span><br><span class="line">	<span class="type">int</span> count = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; Maxsize; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		temp = (Queue *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Queue));</span><br><span class="line">		temp-&gt;front = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">if</span>(i==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			temp-&gt;TimeSlice=T;</span><br><span class="line">			count *= <span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			temp-&gt;TimeSlice = T*count; <span class="comment">// 设置各级队列时间片，当前时间片T，2T，4T，8T...</span></span><br><span class="line">			count*=<span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		temp-&gt;length = <span class="number">10</span>;				 <span class="comment">// 限制队列过长，以免出现饥饿问题</span></span><br><span class="line">		temp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">if</span> (head == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			head = temp;</span><br><span class="line">			temp = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			Queue *temp2;</span><br><span class="line">			temp2 = head;</span><br><span class="line">			<span class="keyword">while</span> (temp2-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				temp2 = temp2-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">			temp2-&gt;next = temp;</span><br><span class="line">			temp = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 初始化进程</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">InitProcess</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> num;</span><br><span class="line">	yellow_printf(<span class="string">&quot;Number of processes:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;num);</span><br><span class="line">	<span class="keyword">while</span> (num &gt; <span class="number">10</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		red_printf(<span class="string">&quot;Exceed the queue length!\n&quot;</span>);</span><br><span class="line">		red_printf(<span class="string">&quot;Please re-energize ...\n&quot;</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;num);</span><br><span class="line">		<span class="comment">// exit(1);</span></span><br><span class="line">	&#125;</span><br><span class="line">	Process *temp;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		temp = (Process *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Process));</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------\n&quot;</span>);</span><br><span class="line">		yellow_printf(<span class="string">&quot;Arrival and run time of the %d process:\n&quot;</span>, i + <span class="number">1</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;temp-&gt;ArrivalTime, &amp;temp-&gt;WorkTime);</span><br><span class="line">		temp-&gt;flag = <span class="number">0</span>;</span><br><span class="line">		temp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		temp-&gt;number = i + <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span> (head-&gt;front == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			temp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">			head-&gt;front = temp;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			Process *temp2;</span><br><span class="line">			temp2 = head-&gt;front;</span><br><span class="line">			<span class="keyword">while</span> (temp2-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				temp2 = temp2-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">			temp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">			temp2-&gt;next = temp;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Insert2NextQueue</span><span class="params">(Process *P, Queue *Q)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 将进程P插入Q队尾</span></span><br><span class="line">	<span class="keyword">if</span> (Q-&gt;front == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		P-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		Q-&gt;front = P;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Process *temp;</span><br><span class="line">		temp = Q-&gt;front;</span><br><span class="line">		<span class="keyword">while</span> (temp-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			temp = temp-&gt;next;</span><br><span class="line">		&#125;</span><br><span class="line">		P-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		temp-&gt;next = P;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">RunFirstProcess</span><span class="params">(Queue *Q)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 如果运行时间小于等于当前队列时间片，说明该进程能运行完</span></span><br><span class="line">	<span class="keyword">if</span> (Q-&gt;front-&gt;WorkTime &lt;= Q-&gt;TimeSlice)</span><br><span class="line">	&#123;</span><br><span class="line">		time += Q-&gt;front-&gt;WorkTime;</span><br><span class="line">		Q-&gt;front-&gt;WorkTime = <span class="number">0</span>;</span><br><span class="line">		Q-&gt;front-&gt;flag = <span class="number">1</span>;</span><br><span class="line">		blue_printf(<span class="string">&quot;Time=%2d : The %2d process is over\n&quot;</span>, time, Q-&gt;front-&gt;number);</span><br><span class="line">		Process *temp, *temp2;</span><br><span class="line">		temp = Finish;</span><br><span class="line">		temp2 = Q-&gt;front-&gt;next;</span><br><span class="line">		<span class="keyword">if</span> (Finish == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Finish = Q-&gt;front;</span><br><span class="line">			Finish-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">while</span> (temp-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				temp = temp-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">			Q-&gt;front-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">			temp-&gt;next = Q-&gt;front;</span><br><span class="line">		&#125;</span><br><span class="line">		Q-&gt;front = temp2;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Q-&gt;front-&gt;WorkTime -= Q-&gt;TimeSlice;</span><br><span class="line">		time += Q-&gt;TimeSlice;</span><br><span class="line">		Process *temp, *temp2;</span><br><span class="line">		temp = Q-&gt;front;</span><br><span class="line">		temp2 = Q-&gt;front-&gt;next;</span><br><span class="line">		<span class="keyword">if</span> (Q-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Insert2NextQueue(temp, Q-&gt;next);</span><br><span class="line">			Q-&gt;front = temp2;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Insert2NextQueue(Q-&gt;front,Q);</span></span><br><span class="line">			<span class="keyword">if</span> (temp2 != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				Q-&gt;front = temp2;</span><br><span class="line">				<span class="keyword">if</span> (temp2-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					temp2 = temp2-&gt;next;</span><br><span class="line">				&#125;</span><br><span class="line">				temp2-&gt;next = temp;</span><br><span class="line">				temp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">SortProcess</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (head-&gt;front == <span class="literal">NULL</span> || head-&gt;front-&gt;next == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 存放已排序的进程</span></span><br><span class="line">	Queue *sorted = (Queue *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Queue));</span><br><span class="line">	sorted-&gt;front = <span class="literal">NULL</span>;</span><br><span class="line">	Process *current = head-&gt;front;</span><br><span class="line">	<span class="keyword">while</span> (current != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 保存当前进程的下一个进程</span></span><br><span class="line">		Process *next = current-&gt;next;</span><br><span class="line">		<span class="comment">// 在已排序队列中找到插入位置的前一个进程</span></span><br><span class="line">		Process *prev = <span class="literal">NULL</span>;</span><br><span class="line">		Process *temp = sorted-&gt;front;</span><br><span class="line">		<span class="keyword">while</span> (temp != <span class="literal">NULL</span> &amp;&amp; temp-&gt;ArrivalTime &lt; current-&gt;ArrivalTime)</span><br><span class="line">		&#123;</span><br><span class="line">			prev = temp;</span><br><span class="line">			temp = temp-&gt;next;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 如果插入位置是已排序队列的第一个位置，更新头结点</span></span><br><span class="line">		<span class="keyword">if</span> (prev == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			current-&gt;next = sorted-&gt;front;</span><br><span class="line">			sorted-&gt;front = current;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 否则，插入到prev和temp之间</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			current-&gt;next = temp;</span><br><span class="line">			prev-&gt;next = current;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 继续处理下一个进程</span></span><br><span class="line">		current = next;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 将原队列的头结点指向已排序队列的头结点</span></span><br><span class="line">	head-&gt;front = sorted-&gt;front;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">MLFQ</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	QLists[<span class="number">1</span>] = head;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt;= Maxsize; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		QLists[i] = QLists[i - <span class="number">1</span>]-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 保证结束的时刻</span></span><br><span class="line">	<span class="keyword">if</span> (QLists[<span class="number">1</span>]-&gt;front != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		time = QLists[<span class="number">1</span>]-&gt;front-&gt;ArrivalTime;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 定义一个标志变量，表示是否有进程运行，0表示没有进程运行</span></span><br><span class="line">		<span class="type">int</span> flag = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= Maxsize; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// 检查每个队列的第一个进程是否满足运行条件</span></span><br><span class="line">			<span class="keyword">if</span> (QLists[i]-&gt;front != <span class="literal">NULL</span> &amp;&amp; time &gt;= QLists[i]-&gt;front-&gt;ArrivalTime)</span><br><span class="line">			&#123;</span><br><span class="line">				RunFirstProcess(QLists[i]);</span><br><span class="line">				<span class="comment">// 将标志变量设为1，表示有进程运行</span></span><br><span class="line">				flag = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 如果标志变量为0，表示没有进程运行</span></span><br><span class="line">		<span class="keyword">if</span> (flag == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">int</span> j=<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">for</span>(j=<span class="number">1</span>;j &lt;= Maxsize;j++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(QLists[j]-&gt;front != <span class="literal">NULL</span>) <span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 判断是否所有进程都运行完毕</span></span><br><span class="line">			<span class="keyword">if</span> (j==Maxsize+<span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				green_printf(<span class="string">&quot;\nAll processes have finished running&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// 如果不是，就增加时间并继续循环</span></span><br><span class="line">				time++;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 初始化队列</span></span><br><span class="line">	InitQueue();</span><br><span class="line">	<span class="comment">// 初始化进程</span></span><br><span class="line">	InitProcess();</span><br><span class="line">	<span class="comment">// 排序，实现抢占</span></span><br><span class="line">	SortProcess();</span><br><span class="line">	yellow_printf(<span class="string">&quot;\nRun!!!\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The result is as follows:\n&quot;</span>);</span><br><span class="line">	MLFQ();</span><br><span class="line">	yellow_printf(<span class="string">&quot;Good day!\n&quot;</span>);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

