<h1 id="实验三：内存管理"><a href="#实验三：内存管理" class="headerlink" title="实验三：内存管理"></a>实验三：内存管理</h1><h2 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h2><ol>
<li>加深对分页存储管理的原理的理解</li>
<li>深入理解分页存储管理如何分配和回收内存</li>
<li>深入理解分页存储管理中的地址变换</li>
</ol>
<h2 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h2><p>假定页面大小为 4K，物理内存 128M，设计并实现一个内存分配和回收的程序，使用 C 语言或 Python 语言编写程序实现这个程序并进行测试。</p>
<p>要求：</p>
<ol>
<li>至少5个进程</li>
<li>要求有空块管理</li>
<li>要求有一个逻辑地址到物理地址的变换</li>
</ol>
<h2 id="程序流程图"><a href="#程序流程图" class="headerlink" title="程序流程图"></a>程序流程图</h2><p><img src="https://www.freeimg.cn/i/2023/12/19/6581377a21e87.png" alt="流程图"></p>
<h2 id="程序代码"><a href="#程序代码" class="headerlink" title="程序代码"></a>程序代码</h2><p>完整代码在最后</p>
<h3 id="结构体与变量"><a href="#结构体与变量" class="headerlink" title="结构体与变量"></a>结构体与变量</h3><h4 id="块大小和数量"><a href="#块大小和数量" class="headerlink" title="块大小和数量"></a>块大小和数量</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#define COUNT 32768   //块数量 128M/4K</span><br><span class="line">#define SIZE 4096   //块大小 4*1024</span><br></pre></td></tr></table></figure>

<h4 id="位视图"><a href="#位视图" class="headerlink" title="位视图"></a>位视图</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> BLOCK[COUNT];  <span class="comment">//物理块状态 0空闲1占用 使用位视图记录空块</span></span><br><span class="line"><span class="type">int</span> BlankBlockNum=COUNT;  <span class="comment">//空块数量</span></span><br></pre></td></tr></table></figure>

<h4 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ProcessList</span> //进程属性</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">int</span> ID; <span class="comment">//进程号</span></span><br><span class="line">	<span class="type">int</span> Size; <span class="comment">//进程大小</span></span><br><span class="line">	<span class="type">int</span> Pages; <span class="comment">//所需页数</span></span><br><span class="line">	<span class="type">int</span> Page[<span class="number">100</span>]; <span class="comment">//页表 </span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ProcessList</span> *<span class="title">next</span>;</span> <span class="comment">//下一进程指针</span></span><br><span class="line">&#125;Process;</span><br></pre></td></tr></table></figure>

<h4 id="进程队列"><a href="#进程队列" class="headerlink" title="进程队列"></a>进程队列</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Process *head=<span class="literal">NULL</span>; <span class="comment">//进程队列</span></span><br></pre></td></tr></table></figure>

<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h4 id="初始化进程、分配内存"><a href="#初始化进程、分配内存" class="headerlink" title="初始化进程、分配内存"></a>初始化进程、分配内存</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">InitProcess</span><span class="params">()</span> <span class="comment">//初始化进程</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> num,RandomNumber;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Please enter the number of processes:\n&quot;</span>); </span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;num);</span><br><span class="line">    <span class="keyword">if</span>(num&lt;<span class="number">5</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        yellow_printf(<span class="string">&quot;The number of processes is at least 5, please re-enter it:\n&quot;</span>);</span><br><span class="line">        <span class="comment">// num=0;</span></span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;num);</span><br><span class="line">    &#125;</span><br><span class="line">	Process *temp;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;num;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		temp = (Process*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Process));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;----------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Enter the sequence number and size of the process:\n&quot;</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>,&amp;temp-&gt;ID,&amp;temp-&gt;Size);</span><br><span class="line">		<span class="keyword">if</span>(i&gt;<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Process *check;</span><br><span class="line">			check=head;</span><br><span class="line">			<span class="keyword">while</span> (check != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(temp-&gt;ID==check-&gt;ID)</span><br><span class="line">				&#123;</span><br><span class="line">					red_printf(<span class="string">&quot;The process already exists, please re-enter it:\n&quot;</span>);</span><br><span class="line">					<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>,&amp;temp-&gt;ID,&amp;temp-&gt;Size);</span><br><span class="line">					<span class="keyword">if</span>(temp-&gt;ID!=check-&gt;ID) <span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				check=check-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//计算进程所需的页数</span></span><br><span class="line">		<span class="keyword">if</span>(temp-&gt;Size%SIZE==<span class="number">0</span>) <span class="comment">//能整除</span></span><br><span class="line">		&#123;</span><br><span class="line">			temp-&gt;Pages = temp-&gt;Size/SIZE; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="comment">//不足一页的部分另起一页</span></span><br><span class="line">		&#123;</span><br><span class="line">			temp-&gt;Pages = temp-&gt;Size/SIZE+<span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		temp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="comment">//空块管理 </span></span><br><span class="line">		<span class="keyword">if</span>(temp-&gt;Pages&lt;BlankBlockNum)</span><br><span class="line">		&#123;</span><br><span class="line">			BlankBlockNum -=temp-&gt;Pages;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			red_printf(<span class="string">&quot;Sorry,there is not enough memory space to allocate!\n&quot;</span>); </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//分配内存 </span></span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;temp-&gt;Pages;j++)</span><br><span class="line">		&#123;</span><br><span class="line">			srand(time(<span class="number">0</span>)); <span class="comment">//随机数种子</span></span><br><span class="line">			<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">                <span class="comment">//模拟实际内存分配不连续性（随机分配）</span></span><br><span class="line">				RandomNumber = rand()%<span class="number">32768</span>;</span><br><span class="line">				<span class="keyword">if</span>(BLOCK[RandomNumber]==<span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					temp-&gt;Page[j] = RandomNumber;</span><br><span class="line">					BLOCK[RandomNumber] = <span class="number">1</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; </span><br><span class="line">		green_printf(<span class="string">&quot;Process %d memory allocation succeeded!\n&quot;</span>,temp-&gt;ID);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The page table is as follows:\n&quot;</span>);</span><br><span class="line">		blue_printf(<span class="string">&quot;Page PhyBlock\n&quot;</span>); </span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;temp-&gt;Pages;j++)</span><br><span class="line">		&#123;</span><br><span class="line">			blue_printf(<span class="string">&quot; %d   %d\n&quot;</span>,j,temp-&gt;Page[j]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//放入进程链表 </span></span><br><span class="line">		<span class="keyword">if</span>(head == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			head = temp;</span><br><span class="line">			temp = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			Process *temp2;</span><br><span class="line">			temp2 = head;</span><br><span class="line">			<span class="keyword">while</span>(temp2-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				temp2 = temp2-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">			temp2-&gt;next = temp;</span><br><span class="line">			temp = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="释放内存"><a href="#释放内存" class="headerlink" title="释放内存"></a>释放内存</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Release</span><span class="params">(<span class="type">int</span> id)</span></span><br><span class="line">&#123;</span><br><span class="line">	Process *temp,*temp1,*temp2;</span><br><span class="line">	temp = head;</span><br><span class="line">	temp1 = head-&gt;next;</span><br><span class="line">	<span class="keyword">if</span>(temp-&gt;ID == id)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;temp-&gt;Pages;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			BLOCK[temp-&gt;Page[i]] = <span class="number">0</span>;</span><br><span class="line">			BlankBlockNum++;</span><br><span class="line">		&#125;</span><br><span class="line">		head = temp1;</span><br><span class="line">		<span class="built_in">free</span>(temp);</span><br><span class="line">		green_printf(<span class="string">&quot;Memory release successful!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span>(temp1)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(temp1-&gt;ID == id)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;temp1-&gt;Pages;i++)</span><br><span class="line">				&#123;</span><br><span class="line">					BLOCK[temp1-&gt;Page[i]] = <span class="number">0</span>;</span><br><span class="line">					BlankBlockNum++;</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				green_printf(<span class="string">&quot;Memory release successful!\n&quot;</span>);</span><br><span class="line">				temp-&gt;next = temp1-&gt;next;</span><br><span class="line">				<span class="built_in">free</span>(temp1);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				temp = temp1;</span><br><span class="line">				temp1=temp1-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	temp2 = head;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The current process memory allocation is as follows:\n&quot;</span>);</span><br><span class="line">	<span class="keyword">while</span>(temp2 != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		yellow_printf(<span class="string">&quot;Process %d\n&quot;</span>,temp2-&gt;ID);</span><br><span class="line">		blue_printf(<span class="string">&quot;Page PhyBlock\n&quot;</span>); </span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;temp2-&gt;Pages;j++)</span><br><span class="line">		&#123;</span><br><span class="line">			blue_printf(<span class="string">&quot; %d   %d\n&quot;</span>,j,temp2-&gt;Page[j]);</span><br><span class="line">		&#125;</span><br><span class="line">		temp2 = temp2-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h4 id="分配内存"><a href="#分配内存" class="headerlink" title="分配内存"></a>分配内存</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> RandomNumber;</span><br><span class="line">	Process *temp;</span><br><span class="line">	temp = (Process*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Process));</span><br><span class="line">	<span class="comment">// printf(&quot;----------------------------------------------------------------------\n&quot;);</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Enter the sequence number and size of the process:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>,&amp;temp-&gt;ID,&amp;temp-&gt;Size);</span><br><span class="line"></span><br><span class="line">	Process *check;</span><br><span class="line">	check=head;</span><br><span class="line">	<span class="keyword">while</span> (check != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(temp-&gt;ID==check-&gt;ID)</span><br><span class="line">		&#123;</span><br><span class="line">			red_printf(<span class="string">&quot;The process already exists, please re-enter it:\n&quot;</span>);</span><br><span class="line">			<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>,&amp;temp-&gt;ID,&amp;temp-&gt;Size);</span><br><span class="line">			<span class="keyword">if</span>(temp-&gt;ID!=check-&gt;ID) <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		check=check-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//计算进程所需的页数</span></span><br><span class="line">	<span class="keyword">if</span>(temp-&gt;Size%SIZE==<span class="number">0</span>) <span class="comment">//能整除</span></span><br><span class="line">	&#123;</span><br><span class="line">		temp-&gt;Pages = temp-&gt;Size/SIZE; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="comment">//不足一页的部分另起一页</span></span><br><span class="line">	&#123;</span><br><span class="line">		temp-&gt;Pages = temp-&gt;Size/SIZE+<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	temp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//空块管理 </span></span><br><span class="line">	<span class="keyword">if</span>(temp-&gt;Pages&lt;BlankBlockNum)</span><br><span class="line">	&#123;</span><br><span class="line">		BlankBlockNum -=temp-&gt;Pages;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		red_printf(<span class="string">&quot;Sorry,there is not enough memory space to allocate!\n&quot;</span>); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//分配内存 </span></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;temp-&gt;Pages;j++)</span><br><span class="line">	&#123;</span><br><span class="line">		srand(time(<span class="number">0</span>)); <span class="comment">//随机数种子</span></span><br><span class="line">		<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//模拟实际内存分配不连续性（随机分配）</span></span><br><span class="line">			RandomNumber = rand()%<span class="number">32768</span>;</span><br><span class="line">			<span class="keyword">if</span>(BLOCK[RandomNumber]==<span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				temp-&gt;Page[j] = RandomNumber;</span><br><span class="line">				BLOCK[RandomNumber] = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	green_printf(<span class="string">&quot;Process %d memory allocation succeeded!\n&quot;</span>,temp-&gt;ID);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The page table is as follows:\n&quot;</span>);</span><br><span class="line">	blue_printf(<span class="string">&quot;Page PhyBlock\n&quot;</span>); </span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;temp-&gt;Pages;j++)</span><br><span class="line">	&#123;</span><br><span class="line">		blue_printf(<span class="string">&quot; %d   %d\n&quot;</span>,j,temp-&gt;Page[j]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//放入进程链表 </span></span><br><span class="line">	<span class="keyword">if</span>(head == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		head = temp;</span><br><span class="line">		temp = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Process *temp2;</span><br><span class="line">		temp2 = head;</span><br><span class="line">		<span class="keyword">while</span>(temp2-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			temp2 = temp2-&gt;next;</span><br><span class="line">		&#125;</span><br><span class="line">		temp2-&gt;next = temp;</span><br><span class="line">		temp = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="逻辑地址转物理地址"><a href="#逻辑地址转物理地址" class="headerlink" title="逻辑地址转物理地址"></a>逻辑地址转物理地址</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">AddressTranslation</span><span class="params">(<span class="type">int</span> id,<span class="type">int</span> LogAddress)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> PhyAddress,P,W;</span><br><span class="line">	Process *temp;</span><br><span class="line">	temp = head;</span><br><span class="line">	<span class="keyword">while</span>(temp != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(temp-&gt;ID == id)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(LogAddress &gt; temp-&gt;Size)</span><br><span class="line">			&#123;</span><br><span class="line">				red_printf(<span class="string">&quot;Break out of bounds!\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>; </span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//物理地址=页号*块大小(4K)+偏移量(逻辑地址)</span></span><br><span class="line">				P = LogAddress / SIZE;</span><br><span class="line">				W = LogAddress % SIZE;</span><br><span class="line">				PhyAddress = temp-&gt;Page[P]*SIZE+W;</span><br><span class="line">				purple_printf(<span class="string">&quot;Calculator: PhyAddress=%d×4K+%d\n&quot;</span>,temp-&gt;Page[P],W);</span><br><span class="line">				yellow_printf(<span class="string">&quot;PhyAddress:%d\n&quot;</span>,PhyAddress);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			temp = temp-&gt;next;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(temp == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		red_printf(<span class="string">&quot;The process does not exist!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">showBlocks</span><span class="params">()</span>； <span class="comment">// 显示空块数和占用数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">showMemory</span><span class="params">()</span>； <span class="comment">// 显示内存分配</span></span><br></pre></td></tr></table></figure>

<h4 id="主函数"><a href="#主函数" class="headerlink" title="主函数"></a>主函数</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	yellow_printf(<span class="string">&quot;Welcome!\n&quot;</span>);</span><br><span class="line">	InitProcess(); <span class="comment">//初始化进程并分配内存</span></span><br><span class="line">	<span class="comment">//Manage();</span></span><br><span class="line">	<span class="type">int</span> n,id,LogAddress;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;----------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Please enter the sequence number of the operation you want to perform:\n1.Free up memory\n2.View physical address\n3.View free blocks\n4.Exit\n&quot;</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;n);</span><br><span class="line">		<span class="keyword">switch</span>(n)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Please enter the ID of the process you want to release:\n&quot;</span>);</span><br><span class="line">				<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;id);</span><br><span class="line">				Release(id);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Enter the process ID and logical address:\n&quot;</span>);</span><br><span class="line">				<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>,&amp;id,&amp;LogAddress);</span><br><span class="line">				AddressTranslation(id,LogAddress);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">				showBlocks();</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">				yellow_printf(<span class="string">&quot;Have a nice day!\n&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				red_printf(<span class="string">&quot;Error!Without this choice!\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><h4 id="创新点"><a href="#创新点" class="headerlink" title="创新点"></a>创新点</h4><ol>
<li>支持动态维护管理</li>
<li>支持实时向内存添加和释放进程</li>
<li>可以随时查看当前内存分配和空块数</li>
<li>程序输出字体颜色根据提示信息有所不同</li>
</ol>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/658137ac76f75.png" alt="初始化"></p>
<h4 id="查看进程-1-物理地址"><a href="#查看进程-1-物理地址" class="headerlink" title="查看进程 1 物理地址"></a>查看进程 1 物理地址</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/658137c0d3582.png" alt="2"></p>
<h4 id="释放进程-1-内存空间"><a href="#释放进程-1-内存空间" class="headerlink" title="释放进程 1 内存空间"></a>释放进程 1 内存空间</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/658137dc6ed90.png" alt="1"></p>
<h4 id="再次查看进程-1"><a href="#再次查看进程-1" class="headerlink" title="再次查看进程 1"></a>再次查看进程 1</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/658137ec41baa.png" alt="2.1"></p>
<p>发现进程不存在</p>
<h4 id="查看当前内存分配"><a href="#查看当前内存分配" class="headerlink" title="查看当前内存分配"></a>查看当前内存分配</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/6581387469188.png" alt="5"></p>
<h4 id="添加进程"><a href="#添加进程" class="headerlink" title="添加进程"></a>添加进程</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/658138810f3c9.png" alt="6"></p>
<h4 id="退出程序"><a href="#退出程序" class="headerlink" title="退出程序"></a>退出程序</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/658138635d93a.png" alt="4"></p>
<h2 id="规范性输入"><a href="#规范性输入" class="headerlink" title="规范性输入"></a>规范性输入</h2><h4 id="实验要求进程数至少为5"><a href="#实验要求进程数至少为5" class="headerlink" title="实验要求进程数至少为5"></a>实验要求进程数至少为5</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/65813894e8ef7.png" alt="进程少于5"></p>
<h4 id="进程重复"><a href="#进程重复" class="headerlink" title="进程重复"></a>进程重复</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/658138b82ca95.png" alt="4"></p>
<h4 id="逻辑地址溢出"><a href="#逻辑地址溢出" class="headerlink" title="逻辑地址溢出"></a>逻辑地址溢出</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/658138d8ef5b4.png" alt="溢出"></p>
<h4 id="查看不存在进程的物理地址"><a href="#查看不存在进程的物理地址" class="headerlink" title="查看不存在进程的物理地址"></a>查看不存在进程的物理地址</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/658138c644af7.png"></p>
<h4 id="释放不存在进程内存"><a href="#释放不存在进程内存" class="headerlink" title="释放不存在进程内存"></a>释放不存在进程内存</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/658138a4e325f.png" alt="释放内存"></p>
<h2 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h2><h4 id="问题-1"><a href="#问题-1" class="headerlink" title="问题 1"></a>问题 1</h4><p>第一版的程序没有考虑内存分配时的随机性</p>
<h4 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案 1"></a>解决方案 1</h4><p>时间作为随机数种子，模拟进程内存的随机分配</p>
<h4 id="问题-2"><a href="#问题-2" class="headerlink" title="问题 2"></a>问题 2</h4><p>进程大小 Size 只能以 bit 为单位，与实际不太相符</p>
<h4 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案 2"></a>解决方案 2</h4><p>实现自定义进程大小单位</p>
<h2 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h2><h4 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ProcessID  Size(bit)</span><br><span class="line">	3		1234</span><br><span class="line">	2		2222</span><br><span class="line">	1		1111</span><br><span class="line">	5		5555</span><br><span class="line">	4		4444</span><br></pre></td></tr></table></figure>

<p>初始化</p>
<ol>
<li>计算进程所需页数</li>
<li>空块管理，即位视图相应位置 1</li>
<li>进行内存分配</li>
<li>进入进程队列</li>
</ol>
<p>操作选项当中本次实验的重点就是逻辑地址与物理地址的转换</p>
<p>计算公式：物理地址 &#x3D; 页号 * 块（页）大小 + 逻辑地址（偏移量）</p>
<p>经过分析，运行结果市正确的，程序完全符合本次实验要求</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span> <span class="comment">//确保包含了这个头文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COUNT 32768   <span class="comment">//块数量 128M/4K</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE 4096   <span class="comment">//块大小 4*1024</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> BLOCK[COUNT];  <span class="comment">//物理块状态 0空闲1占用 使用位视图记录空块</span></span><br><span class="line"><span class="type">int</span> BlankBlockNum=COUNT;  <span class="comment">//空块数量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ProcessList</span> //进程属性</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">int</span> ID; <span class="comment">//进程号</span></span><br><span class="line">	<span class="type">int</span> Size; <span class="comment">//进程大小</span></span><br><span class="line">	<span class="type">int</span> Pages; <span class="comment">//所需页数</span></span><br><span class="line">	<span class="type">int</span> Page[<span class="number">100</span>]; <span class="comment">//页表 </span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ProcessList</span> *<span class="title">next</span>;</span> <span class="comment">//下一进程指针</span></span><br><span class="line">&#125;Process;</span><br><span class="line"></span><br><span class="line">Process *head=<span class="literal">NULL</span>; <span class="comment">//进程队列</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//输出颜色字体</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">color_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* color_code, <span class="type">const</span> <span class="type">char</span>* format, ...)</span> &#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, color_code); <span class="comment">// 设置颜色</span></span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args); <span class="comment">// 打印格式化的文本</span></span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>); <span class="comment">// 重置到默认颜色</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">red_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> &#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">blue_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">green_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> </span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">darkgreen_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> </span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[36m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">yellow_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> </span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[33m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">purple_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> </span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[35m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitProcess</span><span class="params">()</span> <span class="comment">//初始化进程</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> num,RandomNumber;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Please enter the number of processes:\n&quot;</span>); </span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;num);</span><br><span class="line">    <span class="keyword">if</span>(num&lt;<span class="number">5</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        yellow_printf(<span class="string">&quot;The number of processes is at least 5, please re-enter it:\n&quot;</span>);</span><br><span class="line">        <span class="comment">// num=0;</span></span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;num);</span><br><span class="line">    &#125;</span><br><span class="line">	Process *temp;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;num;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		temp = (Process*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Process));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;----------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Enter the sequence number and size of the process:\n&quot;</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>,&amp;temp-&gt;ID,&amp;temp-&gt;Size);</span><br><span class="line">		<span class="keyword">if</span>(i&gt;<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Process *check;</span><br><span class="line">			check=head;</span><br><span class="line">			<span class="keyword">while</span> (check != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(temp-&gt;ID==check-&gt;ID)</span><br><span class="line">				&#123;</span><br><span class="line">					red_printf(<span class="string">&quot;The process already exists, please re-enter it:\n&quot;</span>);</span><br><span class="line">					<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>,&amp;temp-&gt;ID,&amp;temp-&gt;Size);</span><br><span class="line">					<span class="keyword">if</span>(temp-&gt;ID!=check-&gt;ID) <span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				check=check-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//计算进程所需的页数</span></span><br><span class="line">		<span class="keyword">if</span>(temp-&gt;Size%SIZE==<span class="number">0</span>) <span class="comment">//能整除</span></span><br><span class="line">		&#123;</span><br><span class="line">			temp-&gt;Pages = temp-&gt;Size/SIZE; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="comment">//不足一页的部分另起一页</span></span><br><span class="line">		&#123;</span><br><span class="line">			temp-&gt;Pages = temp-&gt;Size/SIZE+<span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		temp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="comment">//空块管理 </span></span><br><span class="line">		<span class="keyword">if</span>(temp-&gt;Pages&lt;BlankBlockNum)</span><br><span class="line">		&#123;</span><br><span class="line">			BlankBlockNum -=temp-&gt;Pages;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			red_printf(<span class="string">&quot;Sorry,there is not enough memory space to allocate!\n&quot;</span>); </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//分配内存 </span></span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;temp-&gt;Pages;j++)</span><br><span class="line">		&#123;</span><br><span class="line">			srand(time(<span class="number">0</span>)); <span class="comment">//随机数种子</span></span><br><span class="line">			<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">                <span class="comment">//模拟实际内存分配不连续性（随机分配）</span></span><br><span class="line">				RandomNumber = rand()%<span class="number">32768</span>;</span><br><span class="line">				<span class="keyword">if</span>(BLOCK[RandomNumber]==<span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					temp-&gt;Page[j] = RandomNumber;</span><br><span class="line">					BLOCK[RandomNumber] = <span class="number">1</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; </span><br><span class="line">		green_printf(<span class="string">&quot;Process %d memory allocation succeeded!\n&quot;</span>,temp-&gt;ID);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;The page table is as follows:\n&quot;</span>);</span><br><span class="line">		blue_printf(<span class="string">&quot;Page PhyBlock\n&quot;</span>); </span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;temp-&gt;Pages;j++)</span><br><span class="line">		&#123;</span><br><span class="line">			blue_printf(<span class="string">&quot; %d   %d\n&quot;</span>,j,temp-&gt;Page[j]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//放入进程链表 </span></span><br><span class="line">		<span class="keyword">if</span>(head == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			head = temp;</span><br><span class="line">			temp = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			Process *temp2;</span><br><span class="line">			temp2 = head;</span><br><span class="line">			<span class="keyword">while</span>(temp2-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				temp2 = temp2-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">			temp2-&gt;next = temp;</span><br><span class="line">			temp = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> RandomNumber;</span><br><span class="line">	Process *temp;</span><br><span class="line">	temp = (Process*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Process));</span><br><span class="line">	<span class="comment">// printf(&quot;----------------------------------------------------------------------\n&quot;);</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Enter the sequence number and size of the process:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>,&amp;temp-&gt;ID,&amp;temp-&gt;Size);</span><br><span class="line"></span><br><span class="line">	Process *check;</span><br><span class="line">	check=head;</span><br><span class="line">	<span class="keyword">while</span> (check != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(temp-&gt;ID==check-&gt;ID)</span><br><span class="line">		&#123;</span><br><span class="line">			red_printf(<span class="string">&quot;The process already exists, please re-enter it:\n&quot;</span>);</span><br><span class="line">			<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>,&amp;temp-&gt;ID,&amp;temp-&gt;Size);</span><br><span class="line">			<span class="keyword">if</span>(temp-&gt;ID!=check-&gt;ID) <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		check=check-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//计算进程所需的页数</span></span><br><span class="line">	<span class="keyword">if</span>(temp-&gt;Size%SIZE==<span class="number">0</span>) <span class="comment">//能整除</span></span><br><span class="line">	&#123;</span><br><span class="line">		temp-&gt;Pages = temp-&gt;Size/SIZE; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="comment">//不足一页的部分另起一页</span></span><br><span class="line">	&#123;</span><br><span class="line">		temp-&gt;Pages = temp-&gt;Size/SIZE+<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	temp-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//空块管理 </span></span><br><span class="line">	<span class="keyword">if</span>(temp-&gt;Pages&lt;BlankBlockNum)</span><br><span class="line">	&#123;</span><br><span class="line">		BlankBlockNum -=temp-&gt;Pages;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		red_printf(<span class="string">&quot;Sorry,there is not enough memory space to allocate!\n&quot;</span>); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//分配内存 </span></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;temp-&gt;Pages;j++)</span><br><span class="line">	&#123;</span><br><span class="line">		srand(time(<span class="number">0</span>)); <span class="comment">//随机数种子</span></span><br><span class="line">		<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//模拟实际内存分配不连续性（随机分配）</span></span><br><span class="line">			RandomNumber = rand()%<span class="number">32768</span>;</span><br><span class="line">			<span class="keyword">if</span>(BLOCK[RandomNumber]==<span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				temp-&gt;Page[j] = RandomNumber;</span><br><span class="line">				BLOCK[RandomNumber] = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	green_printf(<span class="string">&quot;Process %d memory allocation succeeded!\n&quot;</span>,temp-&gt;ID);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The page table is as follows:\n&quot;</span>);</span><br><span class="line">	blue_printf(<span class="string">&quot;Page PhyBlock\n&quot;</span>); </span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;temp-&gt;Pages;j++)</span><br><span class="line">	&#123;</span><br><span class="line">		blue_printf(<span class="string">&quot; %d   %d\n&quot;</span>,j,temp-&gt;Page[j]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//放入进程链表 </span></span><br><span class="line">	<span class="keyword">if</span>(head == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		head = temp;</span><br><span class="line">		temp = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Process *temp2;</span><br><span class="line">		temp2 = head;</span><br><span class="line">		<span class="keyword">while</span>(temp2-&gt;next != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			temp2 = temp2-&gt;next;</span><br><span class="line">		&#125;</span><br><span class="line">		temp2-&gt;next = temp;</span><br><span class="line">		temp = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">showMemory</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	Process *Memorytemp;</span><br><span class="line">	Memorytemp = head;</span><br><span class="line">	green_printf(<span class="string">&quot;The current process memory allocation is as follows:\n&quot;</span>);</span><br><span class="line">	<span class="keyword">while</span>(Memorytemp != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		yellow_printf(<span class="string">&quot;Process %d\n&quot;</span>,Memorytemp-&gt;ID);</span><br><span class="line">		blue_printf(<span class="string">&quot;Page PhyBlock\n&quot;</span>); </span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;Memorytemp-&gt;Pages;j++)</span><br><span class="line">		&#123;</span><br><span class="line">			blue_printf(<span class="string">&quot; %d   %d\n&quot;</span>,j,Memorytemp-&gt;Page[j]);</span><br><span class="line">		&#125;</span><br><span class="line">		Memorytemp = Memorytemp-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Release</span><span class="params">(<span class="type">int</span> id)</span></span><br><span class="line">&#123;</span><br><span class="line">	Process *temp,*temp1,*temp2;</span><br><span class="line">	temp = head;</span><br><span class="line">	temp1 = head-&gt;next;</span><br><span class="line">	<span class="keyword">if</span>(temp-&gt;ID == id)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;temp-&gt;Pages;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			BLOCK[temp-&gt;Page[i]] = <span class="number">0</span>;</span><br><span class="line">			BlankBlockNum++;</span><br><span class="line">		&#125;</span><br><span class="line">		head = temp1;</span><br><span class="line">		<span class="built_in">free</span>(temp);</span><br><span class="line">		green_printf(<span class="string">&quot;Memory release successful!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span>(temp1)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(temp1-&gt;ID == id)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;temp1-&gt;Pages;i++)</span><br><span class="line">				&#123;</span><br><span class="line">					BLOCK[temp1-&gt;Page[i]] = <span class="number">0</span>;</span><br><span class="line">					BlankBlockNum++;</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				green_printf(<span class="string">&quot;Memory release successful!\n&quot;</span>);</span><br><span class="line">				temp-&gt;next = temp1-&gt;next;</span><br><span class="line">				<span class="built_in">free</span>(temp1);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				temp = temp1;</span><br><span class="line">				temp1=temp1-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(temp1==<span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		red_printf(<span class="string">&quot;The process does not exist!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		showMemory();</span><br><span class="line">	&#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="type">void</span> <span class="title function_">AddressTranslation</span><span class="params">(<span class="type">int</span> id,<span class="type">int</span> LogAddress)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> PhyAddress,P,W;</span><br><span class="line">	Process *temp;</span><br><span class="line">	temp = head;</span><br><span class="line">	<span class="keyword">while</span>(temp != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(temp-&gt;ID == id)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(LogAddress &gt; temp-&gt;Size)</span><br><span class="line">			&#123;</span><br><span class="line">				red_printf(<span class="string">&quot;Break out of bounds!\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>; </span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//物理地址=页号*块大小(4K)+偏移量(逻辑地址)</span></span><br><span class="line">				P = LogAddress / SIZE;</span><br><span class="line">				W = LogAddress % SIZE;</span><br><span class="line">				PhyAddress = temp-&gt;Page[P]*SIZE+W;</span><br><span class="line">				purple_printf(<span class="string">&quot;Calculator: PhyAddress=%d×4K+%d\n&quot;</span>,temp-&gt;Page[P],W);</span><br><span class="line">				yellow_printf(<span class="string">&quot;PhyAddress:%d\n&quot;</span>,PhyAddress);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			temp = temp-&gt;next;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(temp == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		red_printf(<span class="string">&quot;The process does not exist!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">showBlocks</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> count=<span class="number">0</span>;</span><br><span class="line">	Process *temp;</span><br><span class="line">	temp=head;</span><br><span class="line">	<span class="keyword">while</span> (temp != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		count+=temp-&gt;Pages;</span><br><span class="line">		temp=temp-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">	darkgreen_printf(<span class="string">&quot;Free Blocks:%d\n&quot;</span>,COUNT-count);</span><br><span class="line">	purple_printf(<span class="string">&quot;Occupy Blocks:%d\n&quot;</span>,count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	yellow_printf(<span class="string">&quot;Welcome!\n&quot;</span>);</span><br><span class="line">	InitProcess(); <span class="comment">//初始化进程并分配内存</span></span><br><span class="line">	green_printf(<span class="string">&quot;\nGot it!\n&quot;</span>);</span><br><span class="line">	<span class="type">int</span> n,id,LogAddress;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;----------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Please enter the sequence number of the operation you want to perform:\n1.Free up memory\n2.Allocate memory\n3.View physical address\n4.View free blocks\n5.View memory allocation\n6.Exit\n&quot;</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;n);</span><br><span class="line">		<span class="keyword">switch</span>(n)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Please enter the ID of the process you want to release:\n&quot;</span>);</span><br><span class="line">				<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;id);</span><br><span class="line">				Release(id);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">				add();</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Enter the process ID and logical address:\n&quot;</span>);</span><br><span class="line">				<span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>,&amp;id,&amp;LogAddress);</span><br><span class="line">				AddressTranslation(id,LogAddress);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">				showBlocks();</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">				showMemory();</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">				yellow_printf(<span class="string">&quot;Have a nice day!\n&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				red_printf(<span class="string">&quot;Error!Without this choice!\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





