<h1 id="实验二：银行家算法"><a href="#实验二：银行家算法" class="headerlink" title="实验二：银行家算法"></a>实验二：银行家算法</h1><h2 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h2><ol>
<li>理解死锁概念，了解导致死锁的原因</li>
<li>掌握死锁的避免算法，理解安全状态和不安全状态的概念</li>
<li>理解银行家算法，并应用银行家算法避免死锁</li>
</ol>
<h2 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h2><p>假定有多个进程对多种资源进行请求，设计银行家算法的数据结构和程序结构，判定是否存在资源分配的安全序列。使用 C 语言或Python 语言编写程序实现这个算法并进行测试</p>
<p>要求：</p>
<ol>
<li>至少5个进程</li>
<li>至少3类资源</li>
<li>结果中包含一个安全的请求和一个不安全的请求</li>
</ol>
<h2 id="程序流程图"><a href="#程序流程图" class="headerlink" title="程序流程图"></a>程序流程图</h2><p><img src="https://www.freeimg.cn/i/2023/12/19/658134ce0e86c.png" alt="流程图"></p>
<h2 id="程序代码"><a href="#程序代码" class="headerlink" title="程序代码"></a>程序代码</h2><p>本次使用了 C 语言进行程序编写，开发环境：Ubuntu 20.04，主要代码如下，完整代码在本文最后：</p>
<h3 id="结构体与变量"><a href="#结构体与变量" class="headerlink" title="结构体与变量"></a>结构体与变量</h3><h4 id="最大需求矩阵"><a href="#最大需求矩阵" class="headerlink" title="最大需求矩阵"></a>最大需求矩阵</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> Max[<span class="number">20</span>][<span class="number">20</span>];             <span class="comment">// Max[i][j]表示进程i对j类资源的最大需求</span></span><br></pre></td></tr></table></figure>

<h4 id="已分配矩阵"><a href="#已分配矩阵" class="headerlink" title="已分配矩阵"></a>已分配矩阵</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> Allocation[<span class="number">20</span>][<span class="number">20</span>];      <span class="comment">// Allocation[i][j]表示已分配给进程i的j类资源数</span></span><br></pre></td></tr></table></figure>

<h4 id="需求矩阵"><a href="#需求矩阵" class="headerlink" title="需求矩阵"></a>需求矩阵</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> Need[<span class="number">20</span>][<span class="number">20</span>]; <span class="comment">// Need[i][j]表示进程i当前所需的j类资源数</span></span><br></pre></td></tr></table></figure>

<h4 id="现可分配资源矩阵"><a href="#现可分配资源矩阵" class="headerlink" title="现可分配资源矩阵"></a>现可分配资源矩阵</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> Available[<span class="number">20</span>]; <span class="comment">// Available[i]表示第i类资源现有资源数</span></span><br></pre></td></tr></table></figure>

<h4 id="请求列表"><a href="#请求列表" class="headerlink" title="请求列表"></a>请求列表</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> request[<span class="number">20</span>]; <span class="comment">// 申请的资源情况</span></span><br></pre></td></tr></table></figure>

<h4 id="试分配后恢复"><a href="#试分配后恢复" class="headerlink" title="试分配后恢复"></a>试分配后恢复</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> AllocationStatus[<span class="number">20</span>];    <span class="comment">// 试分配前Allocation的状态</span></span><br><span class="line"><span class="type">int</span> NeedStatus[<span class="number">20</span>];          <span class="comment">// 试分配前Need状态</span></span><br><span class="line"><span class="type">int</span> AvailableStatus[<span class="number">20</span>];     <span class="comment">// 试分配前Available状态</span></span><br></pre></td></tr></table></figure>

<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> processNum = <span class="number">5</span>;  <span class="comment">// 记录进程个数</span></span><br><span class="line"><span class="type">int</span> resourceNum = <span class="number">3</span>; <span class="comment">// 记录资源类型个数</span></span><br><span class="line"><span class="type">int</span> requireNum = <span class="number">0</span>;  <span class="comment">// 申请进程号</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> WorkStatus[<span class="number">20</span>];          <span class="comment">// 用于检查安全性的工作矩阵</span></span><br><span class="line"><span class="type">bool</span> Finished[<span class="number">20</span>] = &#123;<span class="literal">false</span>&#125;; <span class="comment">// 用于记录进程的完成情况</span></span><br><span class="line"><span class="type">int</span> Safety[<span class="number">20</span>];              <span class="comment">// 安全序列</span></span><br></pre></td></tr></table></figure>

<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h4 id="安全序列判断"><a href="#安全序列判断" class="headerlink" title="安全序列判断"></a>安全序列判断</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">is_safe</span><span class="params">()</span> <span class="comment">// 安全性判断</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i, j, i1 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">bool</span> t = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; resourceNum; i++) <span class="comment">// 把Available赋值给Work</span></span><br><span class="line">    &#123;</span><br><span class="line">        WorkStatus[i] = Available[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; processNum; i++) <span class="comment">// 初始化所有进程未完成</span></span><br><span class="line">    &#123;</span><br><span class="line">        Finished[i] = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; processNum; j++) <span class="comment">// 寻找Need小于等于Work的进程</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Finished[j])</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            t = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; resourceNum; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Need[j][i] &lt;= WorkStatus[i])</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    t = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t)</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// 判断第j个进程是否满足Need小于等于Work</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t &amp;&amp; (Finished[j] == <span class="literal">false</span>)) <span class="comment">// 是否找到Need小于等于Work的进程并且进程未完成</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; resourceNum; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                WorkStatus[i] = WorkStatus[i] + Allocation[j][i];</span><br><span class="line">            &#125;</span><br><span class="line">            Finished[j] = <span class="literal">true</span>; <span class="comment">// 进程完成</span></span><br><span class="line">            Safety[i1] = j+<span class="number">1</span>; <span class="comment">// 安全序列</span></span><br><span class="line">            i1++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; processNum; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Finished[i])</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">getMax</span><span class="params">()</span>;         <span class="comment">// 获取最大需求矩阵 Max</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">getAllocation</span><span class="params">()</span>;  <span class="comment">// 获取分配矩阵 Allocation</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">getNeed</span><span class="params">()</span>;        <span class="comment">// 计算需求矩阵 Need</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">getAvailable</span><span class="params">()</span>;   <span class="comment">// 获取当前可用资源 Available</span></span><br></pre></td></tr></table></figure>

<h4 id="银行家算法"><a href="#银行家算法" class="headerlink" title="银行家算法"></a>银行家算法</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取最大需求矩阵 Max</span></span><br><span class="line">    getMax();</span><br><span class="line">    <span class="comment">// 获取分配矩阵 Allocation</span></span><br><span class="line">    getAllocation();</span><br><span class="line">    <span class="comment">// 计算需求矩阵 Need</span></span><br><span class="line">    getNeed();</span><br><span class="line">    <span class="comment">// 获取当前可用资源</span></span><br><span class="line">    getAvailable();</span><br><span class="line">    <span class="comment">// 申请前检查一次</span></span><br><span class="line">    <span class="keyword">if</span>(!is_safe())</span><br><span class="line">    &#123;</span><br><span class="line">        red_printf(<span class="string">&quot;The current system is not secure!\nResources could not be allocated.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        green_printf(<span class="string">&quot;The system is secure.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取请求信息</span></span><br><span class="line">            getRequirement();</span><br><span class="line">            <span class="comment">// 检查分配后的安全性</span></span><br><span class="line">            <span class="keyword">if</span>(!is_safe())</span><br><span class="line">            &#123;</span><br><span class="line">                red_printf(<span class="string">&quot;After allocation, the system is not secure.\nIt has been restored to its original state!\n&quot;</span>);</span><br><span class="line">                <span class="comment">// 恢复试分配前状态</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; resourceNum; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    Allocation[requireNum<span class="number">-1</span>][i]=AllocationStatus[i];</span><br><span class="line">                    Need[requireNum<span class="number">-1</span>][i]=NeedStatus[i];</span><br><span class="line">                    Available[i]=AvailableStatus[i];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                green_printf(<span class="string">&quot;\nThe request was successful.&quot;</span>);</span><br><span class="line">                blue_printf(<span class="string">&quot;\nA possible safety sequence would be:\n&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; processNum<span class="number">-1</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    blue_printf(<span class="string">&quot;%d-&gt;&quot;</span>, Safety[i]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,Safety[processNum<span class="number">-1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// getchar();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><p>传入的进程信息见上述代码</p>
<h4 id="创新点"><a href="#创新点" class="headerlink" title="创新点"></a>创新点</h4><ol>
<li>该程序可持续对输入案例进行多次请求，会动态维护资源，只要请求合理，就能不断申请</li>
<li>如果申请不符合要求，程序会恢复分配前状态</li>
<li>分配完成后输出分配完以后的资源情况以及一个可行的安全序列</li>
<li>程序输出字体颜色根据提示信息有所不同</li>
</ol>
<h4 id="可行案例（实验提供案例）"><a href="#可行案例（实验提供案例）" class="headerlink" title="可行案例（实验提供案例）"></a>可行案例（实验提供案例）</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/658135113dd1e.png" alt="运行结果"></p>
<p>已修复：安全队列输出的最后一个进程为白色</p>
<p>从上面的结果可以判断，进程 P4 申请（3，2，1）后存在安全序列</p>
<p>查看分配后资源情况以及一个可行的安全序列：</p>
<p><img src="https://www.freeimg.cn/i/2023/12/19/658135256891e.png" alt="资源情况"></p>
<p>当申请超过可分配资源时，进程等待：</p>
<p><img src="https://www.freeimg.cn/i/2023/12/19/658135354ca8b.png"></p>
<h4 id="不可行案例（课程-PPT-案例）"><a href="#不可行案例（课程-PPT-案例）" class="headerlink" title="不可行案例（课程 PPT 案例）"></a>不可行案例（课程 PPT 案例）</h4><p><img src="https://www.freeimg.cn/i/2023/12/19/6581354213b6a.png"></p>
<h2 id="规范性输入"><a href="#规范性输入" class="headerlink" title="规范性输入"></a>规范性输入</h2><p>本实验要求进程数至少为5，资源类至少为3</p>
<p><img src="https://www.freeimg.cn/i/2023/12/19/658135669ba52.png" alt="规范性"></p>
<p>当请求进程号超过进程数时</p>
<p><img src="https://www.freeimg.cn/i/2023/12/19/6581357be0a13.png"></p>
<h2 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h2><h4 id="问题-1"><a href="#问题-1" class="headerlink" title="问题 1"></a>问题 1</h4><p>申请失败时如何恢复原资源情况</p>
<h4 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案 1"></a>解决方案 1</h4><p>在分配前进行备份，便于分配失败恢复</p>
<h2 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h2><p>本实验报告用到两个测试用例</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">ex1</span><br><span class="line">	process          Max               Allocation             Need   </span><br><span class="line">                 r1  r2  r3           r1  r2   r3         r1   r2  r3 </span><br><span class="line">      P0         6   4   3            1   1    0          5    3   3  </span><br><span class="line">      P1         3   2   4            2   0    1          1    2   3</span><br><span class="line">      P2         9   0   3            4   0    2          5    0   1 </span><br><span class="line">      P3         2   2   2            2   1    1          0    1   1 </span><br><span class="line">      P4         3   4   3            0   1    2          3    3   1</span><br><span class="line">	</span><br><span class="line">	Available</span><br><span class="line">	r1  r2  r3</span><br><span class="line">	3   3   2</span><br><span class="line">P4申请（3，2，1），是否存在安全序列？</span><br><span class="line"></span><br><span class="line">ex2</span><br><span class="line">	process          Max               Allocation             Need   </span><br><span class="line">                 r1  r2  r3           r1  r2   r3         r1   r2  r3 </span><br><span class="line">      P0         7   5   3            0   1    0          7    4   3  </span><br><span class="line">      P1         3   2   2            2   0    0          1    2   2</span><br><span class="line">      P2         9   0   2            3   0    2          6    0   0 </span><br><span class="line">      P3         2   2   2            2   1    1          0    1   1 </span><br><span class="line">      P4         4   3   3            0   0    2          4    3   1</span><br><span class="line"></span><br><span class="line">	Available</span><br><span class="line">	r1  r2  r3 </span><br><span class="line">	3   3   2</span><br><span class="line">P1申请(1，0，2)后，P0申请（0，2，0）</span><br></pre></td></tr></table></figure>

<p>银行家算法的核心就是试分配后的安全行判断，需要考虑到进程之间的排列组合，找到一种可行的安全序列即可。结果运行以后程序输出应该已经非常清晰了，这里就不再赘述。</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> processNum = <span class="number">5</span>;  <span class="comment">// 记录进程个数</span></span><br><span class="line"><span class="type">int</span> resourceNum = <span class="number">3</span>; <span class="comment">// 记录资源类型个数</span></span><br><span class="line"><span class="type">int</span> requireNum = <span class="number">0</span>;  <span class="comment">// 申请进程号</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用的数据结构</span></span><br><span class="line"><span class="type">int</span> Max[<span class="number">20</span>][<span class="number">20</span>];             <span class="comment">// Max[i][j]表示进程i对j类资源的最大需求</span></span><br><span class="line"><span class="type">int</span> Allocation[<span class="number">20</span>][<span class="number">20</span>];      <span class="comment">// Allocation[i][j]表示已分配给进程i的j类资源数</span></span><br><span class="line"><span class="type">int</span> Need[<span class="number">20</span>][<span class="number">20</span>];            <span class="comment">// Need[i][j]表示进程i当前所需的j类资源数</span></span><br><span class="line"><span class="type">int</span> Available[<span class="number">20</span>];           <span class="comment">// Available[i]表示第i类资源现有资源数</span></span><br><span class="line"><span class="type">int</span> request[<span class="number">20</span>];             <span class="comment">// 申请的资源情况</span></span><br><span class="line"><span class="type">int</span> WorkStatus[<span class="number">20</span>];          <span class="comment">// 用于检查安全性的工作矩阵</span></span><br><span class="line"><span class="type">bool</span> Finished[<span class="number">20</span>] = &#123;<span class="literal">false</span>&#125;; <span class="comment">// 用于记录进程的完成情况</span></span><br><span class="line"><span class="type">int</span> Safety[<span class="number">20</span>];              <span class="comment">// 安全序列</span></span><br><span class="line"><span class="type">int</span> AllocationStatus[<span class="number">20</span>];    <span class="comment">// 试分配前Allocation的状态</span></span><br><span class="line"><span class="type">int</span> NeedStatus[<span class="number">20</span>];          <span class="comment">// 试分配前Need状态</span></span><br><span class="line"><span class="type">int</span> AvailableStatus[<span class="number">20</span>];     <span class="comment">// 试分配前Available状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//输出颜色字体</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">color_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* color_code, <span class="type">const</span> <span class="type">char</span>* format, ...)</span> &#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, color_code); <span class="comment">// 设置颜色</span></span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args); <span class="comment">// 打印格式化的文本</span></span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>); <span class="comment">// 重置到默认颜色</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">red_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> &#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">blue_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">green_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> </span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">darkgreen_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> </span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[36m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">yellow_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> </span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[33m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">purple_printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span> </span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[35m&quot;</span>);</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vprintf</span>(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取最大需求矩阵 Max</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">getMax</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    yellow_printf(<span class="string">&quot;Welcome!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please enter the number of processes and the number of resource classes:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;processNum, &amp;resourceNum);</span><br><span class="line">        <span class="comment">// 针对本次实验的参数要求验证</span></span><br><span class="line">        <span class="keyword">if</span> (processNum &lt; <span class="number">5</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            red_printf(<span class="string">&quot;\nIf the number of processes is at least 5, enter them again.\n&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (resourceNum &lt; <span class="number">3</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            red_printf(<span class="string">&quot;\nThe resource category is at least 3, please re-enter it.\n&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n-----------------------------------\n&quot;</span>);</span><br><span class="line">    yellow_printf(<span class="string">&quot;Please enter the Max matrix:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; processNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%2d process:\n&quot;</span>, i + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; resourceNum; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// int maxij=0;</span></span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;Max[i][j]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// printf(&quot;\n&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取已分配资源</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">getAllocation</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;-----------------------------------\n&quot;</span>);</span><br><span class="line">    yellow_printf(<span class="string">&quot;Please enter the Allocation matrix:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; processNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d process assigned:\n&quot;</span>, i + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; resourceNum; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// int maxij=0;</span></span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;Allocation[i][j]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// printf(&quot;\n&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算需求矩阵，这一部分可以和获取资源分配同时进行，减少循环次数，这里分开写显示逻辑性</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">getNeed</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; processNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; resourceNum; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            Need[i][j] = Max[i][j] - Allocation[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    green_printf(<span class="string">&quot;\nThe Need matrix is calculated\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getAvailable</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;-----------------------------------\n&quot;</span>);</span><br><span class="line">    yellow_printf(<span class="string">&quot;Enter the Available matrix:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; resourceNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;Available[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    green_printf(<span class="string">&quot;\nGot it!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 接收资源请求</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">getRequirement</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;-----------------------------------\n&quot;</span>);</span><br><span class="line">    yellow_printf(<span class="string">&quot;Enter the request process number:&quot;</span>);</span><br><span class="line">    <span class="comment">// int pnum=0;</span></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;requireNum);</span><br><span class="line">    <span class="keyword">while</span>(requireNum&gt;processNum)</span><br><span class="line">    &#123;</span><br><span class="line">        red_printf(<span class="string">&quot;\nOps!This process does not exist!\nPlease re-enter it:&quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;requireNum);</span><br><span class="line">    &#125;</span><br><span class="line">    Safety[<span class="number">0</span>] = requireNum;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; resourceNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The %d class resource requires:\n&quot;</span>, i + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// int num=0;</span></span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;request[i]);</span><br><span class="line">        <span class="keyword">if</span> (request[i] &gt; Need[requireNum - <span class="number">1</span>][i])</span><br><span class="line">        &#123;</span><br><span class="line">            red_printf(<span class="string">&quot;\nError\nThe number of resources requested is more than the current need!\nDon&#x27;t be too greedy!\n&quot;</span>);</span><br><span class="line">            getRequirement();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (request[i] &gt; Available[i])</span><br><span class="line">        &#123;</span><br><span class="line">            red_printf(<span class="string">&quot;\nProcess %d is blocked\n&quot;</span>, requireNum);</span><br><span class="line">            getRequirement();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 保留现场</span></span><br><span class="line">            AvailableStatus[i]=Available[i];</span><br><span class="line">            AllocationStatus[i]=Allocation[requireNum<span class="number">-1</span>][i];</span><br><span class="line">            NeedStatus[i]=Need[requireNum<span class="number">-1</span>][i]; </span><br><span class="line">            <span class="comment">// 试分配</span></span><br><span class="line">            Available[i] -= request[i];</span><br><span class="line">            Allocation[requireNum - <span class="number">1</span>][i] += request[i];</span><br><span class="line">            Need[requireNum - <span class="number">1</span>][i] -= request[i];</span><br><span class="line">            Finished[requireNum - <span class="number">1</span>] = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">is_safe</span><span class="params">()</span> <span class="comment">// 安全性判断</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i, j, i1 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">bool</span> t = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; resourceNum; i++) <span class="comment">// 把Available赋值给Work</span></span><br><span class="line">    &#123;</span><br><span class="line">        WorkStatus[i] = Available[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; processNum; i++) <span class="comment">// 初始化所有进程未完成</span></span><br><span class="line">    &#123;</span><br><span class="line">        Finished[i] = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; processNum; j++) <span class="comment">// 寻找Need小于等于Work的进程</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Finished[j])</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            t = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; resourceNum; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Need[j][i] &lt;= WorkStatus[i])</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    t = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t)</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// 判断第j个进程是否满足Need小于等于Work</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t &amp;&amp; (Finished[j] == <span class="literal">false</span>)) <span class="comment">// 是否找到Need小于等于Work的进程并且进程未完成</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; resourceNum; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                WorkStatus[i] = WorkStatus[i] + Allocation[j][i];</span><br><span class="line">            &#125;</span><br><span class="line">            Finished[j] = <span class="literal">true</span>; <span class="comment">// 进程完成</span></span><br><span class="line">            Safety[i1] = j+<span class="number">1</span>; <span class="comment">// 安全序列</span></span><br><span class="line">            i1++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; processNum; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Finished[i])</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">showResource</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;-------------------------------------------\n&quot;</span>);</span><br><span class="line">    red_printf(<span class="string">&quot;Current resource situation\n&quot;</span>);</span><br><span class="line">    yellow_printf(<span class="string">&quot;process      Max      Allocation     Need\n          &quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;resourceNum;j++)</span><br><span class="line">        &#123;</span><br><span class="line">            yellow_printf(<span class="string">&quot;r%d &quot;</span>,j+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;processNum;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        yellow_printf(<span class="string">&quot;P%d       &quot;</span>,i+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;resourceNum;j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%2d &quot;</span>,Max[i][j]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;resourceNum;j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%2d &quot;</span>,Allocation[i][j]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;resourceNum;j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%2d &quot;</span>,Need[i][j]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">showAvailable</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    yellow_printf(<span class="string">&quot;\nAvailable\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;resourceNum;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        yellow_printf(<span class="string">&quot;r%d &quot;</span>,i+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;resourceNum;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%2d &quot;</span>,Available[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取最大需求矩阵 Max</span></span><br><span class="line">    getMax();</span><br><span class="line">    <span class="comment">// 获取分配矩阵 Allocation</span></span><br><span class="line">    getAllocation();</span><br><span class="line">    <span class="comment">// 计算需求矩阵 Need</span></span><br><span class="line">    getNeed();</span><br><span class="line">    <span class="comment">// 获取当前可用资源</span></span><br><span class="line">    getAvailable();</span><br><span class="line">    <span class="comment">// 申请前检查一次</span></span><br><span class="line">    <span class="keyword">if</span>(!is_safe())</span><br><span class="line">    &#123;</span><br><span class="line">        red_printf(<span class="string">&quot;The current system is not secure!\nResources could not be allocated.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        green_printf(<span class="string">&quot;The system is secure.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取请求信息</span></span><br><span class="line">            getRequirement();</span><br><span class="line">            <span class="comment">// 检查分配后的安全性</span></span><br><span class="line">            <span class="keyword">if</span>(!is_safe())</span><br><span class="line">            &#123;</span><br><span class="line">                red_printf(<span class="string">&quot;After allocation, the system is not secure.\nIt has been restored to its original state!\n&quot;</span>);</span><br><span class="line">                <span class="comment">// 恢复试分配前状态</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; resourceNum; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    Allocation[requireNum<span class="number">-1</span>][i]=AllocationStatus[i];</span><br><span class="line">                    Need[requireNum<span class="number">-1</span>][i]=NeedStatus[i];</span><br><span class="line">                    Available[i]=AvailableStatus[i];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                green_printf(<span class="string">&quot;\nThe request was successful.&quot;</span>);</span><br><span class="line">                blue_printf(<span class="string">&quot;\nA possible safety sequence would be:\n&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; processNum<span class="number">-1</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    blue_printf(<span class="string">&quot;%d-&gt;&quot;</span>, Safety[i]);</span><br><span class="line">                &#125;</span><br><span class="line">                blue_printf(<span class="string">&quot;%d\n&quot;</span>,Safety[processNum<span class="number">-1</span>]);</span><br><span class="line">                <span class="comment">// 输出当前资源情况</span></span><br><span class="line">                showResource();</span><br><span class="line">                showAvailable();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// getchar();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

